{% extends "base.html" %}
{% load staticfiles %}
{% block header %}
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
{% endblock %}

{% block sidebar %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
            <img src="{{ namespace_icon }}" height="64" class="media-object">
        </div>
        <div class="media-body">
            <h2 class="media-heading">{{ package.namespace }}</h2>Side Panel
        </div>
    </div>
</div>
<div class="panel panel-info">
    <div class="panel-heading">
        <h3 class="panel-title">Package Visualization</h3>
    </div>
    <div id="tree-container" class="panel-body">
    </div>
</div>
<div class="panel panel-info">
    <div class="panel-heading">
        <h3 class="panel-title">Quickstart Panel
            <i class="fa fa-question-circle fa-sm" data-container="body" data-toggle="popover" data-placement="right" data-content="List of all        network and filesystem based indicators, such as domains, IP addresses, and file hashes. Items can also be exported and downloaded as a csv file."></i>
        </h3>
    </div>
    <div id="quick-container" class="panel-body">
    {% if 'URIObjectType' in quick_pane %}
        <table id="uri_quick_table" class="table table-condensed table-borderless" style="font-size: small;">
            <thead><tr><th><button class="btn btn-danger btn-xs"><i class="fa fa-download"></i> export</button> URLs/Domains</th></tr></thead>
            <tbody>
                    <tr>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    {% endif %}
    {% if 'FileObjectType' in quick_pane %}
        <table id="hashes_quick_table" class="table table-condensed table-borderless" style="font-size: small;">
            <thead><tr><th><button class="btn btn-danger btn-xs"><i class="fa fa-download"></i> export</button> Hashes</th></tr></thead>
            <tbody>
                    <tr>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    {% endif %}
    </div>
</div>
{% endspaceless %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
            <img src="{% static 'images/Package.png' %}" height="64" class="media-object">
        </div>
        <div class="media-body">
            <h2 class="media-heading">{{ package.name }}</h2>Intelligence Package ID: {{ package_id }}
        </div>
    </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}
{% if package %}
{% spaceless %}
<div class="panel panel-info">
    <div class="panel-heading">
        <h3 class="panel-title">{{ package.name }}</h3>
    </div>
    <table class="table table-condensed table-borderless">
        <tbody>
            <tr>
                <td align="right"><b>Namespace</b></td>
                <td>{{ package.namespace }}</td>
                <td align="right"><b>Produced Time</b></td>
                <td>{{ package.produced_time }}</td>
            </tr>
            <tr>
                <td align="right"><b>Import Time</b></td>
                <td>{{ package.creation_time }}</td>
                <td align="right"><b>Modified Time</b></td>
                <td>{{ package.last_modified }}</td>
            </tr>
            <tr>
                <td align="right"><b>STIX Version</b></td>
                <td>{{ package.version }}</td>
                <td align="right"><b>Source</b></td>
                <td>{{ package.source }}</td>
            </tr>
        </tbody>
    </table>
    <div class="panel-body">
        <pre class="pre-scrollable wrapdiv">
        {{ package.description }}
        </pre>
    </div>
</div>
{% endspaceless %}

<div role="tabpanel">
  {% spaceless %}
  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    {% if num_threat_actors > 0 %}
    <li role="presentation" {% if tab == 'threatactors' %}class="active"{% endif %}>
        <a href="#threatactors" aria-controls="threatactors" role="tab" data-toggle="tab">
            <img src="{% static 'images/Threat Actor.png' %}" height="32">&nbsp;&nbsp;Threat Actors
            <span class="badge">{{ num_threat_actors }}</span>
        </a>
    </li>
    {% endif %}
    {% if num_campaigns > 0 %}
    <li role="presentation" {% if tab == 'campaigns' %}class="active"{% endif %}>
        <a href="#campaigns" aria-controls="campaigns" role="tab" data-toggle="tab">
            <img src="{% static 'images/Campaign.png' %}" height="32">&nbsp;&nbsp;Campaigns
            <span class="badge">{{ num_campaigns }}</span>
        </a>
    </li>
    {% endif %}
    {% if num_indicators > 0 %}
    <li role="presentation" {% if tab == 'indicators' %}class="active"{% endif %}>
        <a href="#indicators" aria-controls="indicators" role="tab" data-toggle="tab">
            <img src="{% static 'images/Indicator.png' %}" height="32">&nbsp;&nbsp;Indicators
            <span class="badge">{{ num_indicators }}</span>
        </a>
    </li>
    {% endif %}
    {% if num_observables > 0 %}
    <li role="presentation" {% if tab == 'observables' %}class="active"{% endif %}>
        <a href="#observables" aria-controls="observables" role="tab" data-toggle="tab">
            <img src="{% static 'images/Observable.png' %}" height="32">&nbsp;&nbsp;Observables
            <span class="badge">{{ num_observables }}</span>
        </a>
    </li>
    {% endif %}
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <!-- THREAT ACTOR -->
    <div role="tabpanel" class="tab-pane {% if tab == 'threatactors' %}active{% endif %}" id="threatactors">
        <br/>
        <table id="threatactors_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Short Description</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- CAMPAIGN -->
    <div role="tabpanel" class="tab-pane {% if tab == 'campaigns' %}active{% endif %}" id="campaigns">
        <br/>
        <table id="campaigns_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Confidence</th><th>Status</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- INDICATOR -->
    <div role="tabpanel" class="tab-pane {% if tab == 'indicators' %}active{% endif %}" id="indicators">
        <br/>
        <table id="indicators_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Type</th><th>Confidence</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- OBSERVABLE -->
    <div role="tabpanel" class="tab-pane {% if tab == 'observables' %}active{% endif %}" id="observables">
        <br/>
        <table id="observables_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Type</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
  </div>
  {% endspaceless %}
</div>

{% endif %}
{% endblock%}

{% block javascript%}
<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#uri_quick_table').DataTable({
            ordering: false,
            paging: false,
            info: false,
            filter: false,
            processing: true,
            serverSide: true,
            oLanguage: {
                sProcessing: "<img src='{% static 'images/loading.gif' %}'>",
            },
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/quick/URIObjectType/",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'value', 
                    'sName': 'hash', 
                    'aTargets': [ 1 ]
                }
            ],
        });
    });
</script>

<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#hashes_quick_table').DataTable({
            ordering: false,
            paging: false,
            info: false,
            filter: false,
            processing: true,
            serverSide: true,
            oLanguage: {
                sProcessing: "<img src='{% static 'images/loading.gif' %}'>",
            },
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/quick/FileObjectType/",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'value', 
                    'sName': 'hash', 
                    'aTargets': [ 1 ]
                }
            ],
        });
    });
</script>

<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#observables_table').DataTable({
            processing: true,
            serverSide: true,
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/observables/.json",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'name', 
                    'sName': 'name', 
                    'aTargets': [ 1 ],
                    'mRender': function (data, type, full) {
                        var view_url = "{% url 'intel:observable' observable_id=0 %}".replace(0, Number(full.id));
                        return '<a href="'+view_url+'">'+data+'</a>';
                    }
                },
                {'data': 'observable_type', 'sName': 'type', 'aTargets': [ 2 ]},
            ],
        });
    });
</script>

<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#indicators_table').DataTable({
            processing: true,
            serverSide: true,
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/indicators/.json",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'name', 
                    'sName': 'name', 
                    'aTargets': [ 1 ],
                    'mRender': function (data, type, full) {
                        var view_url = "{% url 'intel:indicator' indicator_id=0 %}".replace(0, Number(full.id));
                        return '<a href="'+view_url+'">'+data+'</a>';
                    }
                },
                {'data': 'indicator_types', 'sName': 'type', 'aTargets': [ 2 ]},
                {'data': 'confidence', 'sName': 'confidence', 'aTargets': [ 3 ]},
            ],
        });
    });
</script>

<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#campaigns_table').DataTable({
            processing: true,
            serverSide: true,
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/campaigns/.json",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'name', 
                    'sName': 'name', 
                    'aTargets': [ 1 ]
                },
                {'data': 'confidence', 'sName': 'confidence', 'aTargets': [ 2 ]},
                {'data': 'status', 'sName': 'status', 'aTargets': [ 3 ]},
            ],
        });
    });
</script>

<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
        var pTable = $('#threatactors_table').DataTable({
            processing: true,
            serverSide: true,
            order: [[ 0, "desc" ]],
            ajax: {
                processing: true,
                url: "/api/packages/{{ package_id }}/threatactors/.json",
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'name', 
                    'sName': 'name', 
                    'aTargets': [ 1 ]
                },
                {'data': 'short_description', 'sName': 'short_description', 'aTargets': [ 2 ]},
            ],
        });
    });
</script>


<script type="text/javascript" language="javascript" class="init">
var w = 500;
var h = 250;
var adjustme = 170;
var keyi = true, keyo = true, keyp = true;
var focus_node = null, highlight_node = null;
var text_center = false;
var outline = false;
var min_score = 0;
var max_score = 1;
var color = d3.scale.linear()
  .domain([min_score, (min_score+max_score)/2, max_score])
  .range(["lime", "yellow", "red"]);

var highlight_color = "#f1c40f";
var highlight_trans = 0.1;
var size = d3.scale.pow().exponent(1)
  .domain([1,100])
  .range([8,24]);
    
var force = d3.layout.force()
  .linkDistance(100)
  .charge(-300)
  .size([w,h]);

var default_node_color = "#34495e";
var default_link_color = "#2c3e50";
var nominal_base_node_size = 8;
var nominal_text_size = 10;
var max_text_size = 24;
var nominal_stroke = 1.5;
var max_stroke = 4.5;
var max_base_node_size = 36;
var min_zoom = 0.1;
var max_zoom = 7;
var svg = d3.select("#tree-container").append("svg");
var zoom = d3.behavior.zoom().scaleExtent([min_zoom,max_zoom])
var g = svg.append("g");
svg.style("cursor","move");

d3.json("/api/packagesd3/tree/{{ package_id }}/", function(error, graph) {

var linkedByIndex = {};
    graph.links.forEach(function(d) {
    linkedByIndex[d.source + "," + d.target] = true;
    });

    function isConnected(a, b) {
        return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
    }

    function hasConnections(a) {
        for (var property in linkedByIndex) {
                s = property.split(",");
                if ((s[0] == a.index || s[1] == a.index) && linkedByIndex[property])                    return true;
        }
    return false;
    }
    
  force
    .nodes(graph.nodes)
    .links(graph.links)
    .start();

  var link = g.selectAll(".link")
    .data(graph.links)
    .enter().append("line")
    .attr("class", "link")
    .style("stroke-width",nominal_stroke)
    .style("stroke", function(d) {
    return default_link_color; })

  var node = g.selectAll(".node")
    .data(graph.nodes)
    .enter().append("g")
    .attr("class", "node")
    
    .call(force.drag)

    node.on("dblclick.zoom", function(d) { d3.event.stopPropagation();
    var dcx = (w/2-d.x*zoom.scale());
    var dcy = ((h-10)/2-d.y*zoom.scale());
    zoom.translate([dcx,dcy]);
     g.attr("transform", "translate("+ dcx + "," + dcy  + ")scale(" + zoom.scale() + ")");
    });
    
    var tocolor = "fill";
    var towhite = "stroke";
    if (outline) {
        tocolor = "stroke"
        towhite = "fill"
    }
    
  var circle = node.append("path")
      .attr("d", d3.svg.symbol()
        .size(function(d) { return Math.PI*Math.pow(size(d.size)||nominal_base_node_size,2); })
        .type(function(d) { return d.type; }))
  
      .style(tocolor, function(d) {
    if (isNumber(d.score) && d.score==1) return "#9b59b6";
    else if (isNumber(d.score) && d.score==0.6) return "#3498db";
    else if (isNumber(d.score) && d.score==0.3) return "#f1c40f";
    else if (isNumber(d.score) && d.score==0.5) return "#2980b9";
    else if (isNumber(d.score) && d.score==0.7) return "#e74c3c";
    else return default_node_color; })
    .style("stroke-width", nominal_stroke)
    .style(towhite, "white");
                
  var text = g.selectAll(".text")
    .data(graph.nodes)
    .enter().append("text")
    .attr("dy", ".35em")
    .style("font-size", nominal_text_size + "px")

    if (text_center)
     text.text(function(d) { return d.id; })
    .style("text-anchor", "middle");
    else 
    text.attr("dx", function(d) {return (size(d.size)||nominal_base_node_size);})
    .text(function(d) { return '\u2002'+d.id; });

    node.on("mouseover", function(d) {
    set_highlight(d);
    })
  .on("mousedown", function(d) { d3.event.stopPropagation();
    focus_node = d;
    set_focus(d)
    if (highlight_node === null) set_highlight(d)
    
}   ).on("mouseout", function(d) {
        exit_highlight();
}   );

        d3.select(window).on("mouseup",  
        function() {
        if (focus_node!==null)
        {
            focus_node = null;
            if (highlight_trans<1)
            {
        circle.style("opacity", 1);
      text.style("opacity", 1);
      link.style("opacity", 1);
    }
        }
    
    if (highlight_node === null) exit_highlight();
        });

function exit_highlight()
{
        highlight_node = null;
    if (focus_node===null)
    {
        svg.style("cursor","move");
        if (highlight_color!="white")
    {
      circle.style(towhite, "white");
      text.style("font-weight", "normal");
      link.style("stroke", function(o) {return (isNumber(o.score) && o.score>=0)?color(o.score):default_link_color});
    }
            
    }
}

function set_focus(d)
{   
if (highlight_trans<1)  {
    circle.style("opacity", function(o) {
                return isConnected(d, o) ? 1 : highlight_trans;
            });

            text.style("opacity", function(o) {
                return isConnected(d, o) ? 1 : highlight_trans;
            });
            
            link.style("opacity", function(o) {
                return o.source.index == d.index || o.target.index == d.index ? 1 : highlight_trans;
            });     
    }
}

function set_highlight(d)
{
    svg.style("cursor","pointer");
    if (focus_node!==null) d = focus_node;
    highlight_node = d;
    if (highlight_color!="white")
    {
          circle.style(towhite, function(o) {
                return isConnected(d, o) ? highlight_color : "white";});
            text.style("font-weight", function(o) {
                return isConnected(d, o) ? "bold" : "normal";});
            link.style("stroke", function(o) {
              return o.source.index == d.index || o.target.index == d.index ? highlight_color : ((isNumber(o.score) && o.score>=0)?color(o.score):default_link_color);

            });
    }
}
    
  zoom.on("zoom", function() {
    var stroke = nominal_stroke;
    if (nominal_stroke*zoom.scale()>max_stroke) stroke = max_stroke/zoom.scale();
    link.style("stroke-width",stroke);
    circle.style("stroke-width",stroke);
       
    var base_radius = nominal_base_node_size;
    if (nominal_base_node_size*zoom.scale()>max_base_node_size) base_radius = max_base_node_size/zoom.scale();
        circle.attr("d", d3.svg.symbol()
        .size(function(d) { return Math.PI*Math.pow(size(d.size)*base_radius/nominal_base_node_size||base_radius,2); })
        .type(function(d) { return d.type; }))
        
    if (!text_center) text.attr("dx", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); });
    
    var text_size = nominal_text_size;
    if (nominal_text_size*zoom.scale()>max_text_size) text_size = max_text_size/zoom.scale();
    text.style("font-size",text_size + "px");
    g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    });
     
  svg.call(zoom);     
  resize();
  d3.select(window).on("resize", resize);
      
  force.on("tick", function() {
    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    text.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
    node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
    });
  
  function resize() {
    var width = w, height = h;
    svg.attr("width", width).attr("height", height);
    force.size([force.size()[0]+(width-w-adjustme)/zoom.scale(),force.size()[1]+(height-h)/zoom.scale()]).resume();
    w = width;
    h = height;
    }

});

function isNumber(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

$(function () {
    $('[data-toggle="popover"]').popover()
});
</script>
{% endblock%}
