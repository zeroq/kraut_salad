{% extends "base.html" %}
{% load staticfiles %}
{% load split_at %}
{% block header %}
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.addimage {
  margin-right:10px;
}

</style>
{% endblock %}

{% block sidebar %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
            <img src="{{ namespaceicon }}" height="64" class="media-object">
        </div>
        <div class="media-body">
            <h2 class="media-heading">{{ incident.incident_number }}</h2>Side Panel
        </div>
    </div>
</div>
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">Affected Assets</h3>
    </div>
    <div id="tree-container" class="panel-body">
    </div>
</div>
{% endspaceless %}
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
            <img src="{% static 'images/Incident.svg' %}" height="64" class="media-object" />
        </div>
        <div class="media-body">
            <h2 class="media-heading">{{ incident.title }}</h2>Incident: {{ incident.incident_number }}
        </div>
    </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}
{% if incident %}
{% spaceless %}
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">{{ incident.title }}<i id="toggle-commentsidebar" class="fa fa-comment-o pull-right" data-toggle="tooltip" data-placement="top" data-original-title="add comment"></i><i id="toggle-navsidebar" class="fa fa-pencil-square-o pull-right" data-toggle="tooltip" data-placement="top" data-original-title="edit meta-information"></i></h3>
    </div>
    <table class="table table-condensed table-borderless">
        <tbody>
            <tr>
                <td align="right"><b>Incident Number</b></td>
                <td>{{ incident.incident_number }}</td>
                <td align="right"><b>Severity</b></td>
                <td>{{ severity }}</td>
            </tr>
            <tr>
                <td align="right"><b>Import Time</b></td>
                <td>{{ incident.creation_time }}</td>
                <td align="right"><b>Modified Time</b></td>
                <td>{{ incident.last_modified }}</td>
            </tr>
            <tr>
                <td align="right"><b>Status</b></td>
                <td>{{ incident.status }}</td>
                <td align="right"><b>Category</b></td>
                <td>{{ incident.category }}</td>
            </tr>
        </tbody>
    </table>
    <div class="panel-body">
        <pre class="pre-scrollable wrapdiv">{{ incident.description }}</pre>
    </div>
</div>
<div id="navsidebar" class="navsidebar navsidebar-right">
  <div id="navsidebar-wrapper" class="navsidebar-wrapper">
    <header class="navsidebar-header"><i class="fa fa-pencil-square-o"></i>&nbsp;Kraut Editor</header>
    <nav class="navsidebar-menu">
        <form action="{% url 'incidents:update_incident_header' incident_id=incident_id %}" method="POST">
        {% csrf_token %}
            <ul>
                <li>Title</li>
                <li><input name="incident_title" class="form-control" type="text" value="{{ incident.title }}"></li>
                <li>Severity<br/></li>
                <li>
                <select class="form-control" name="incident_severity">
                    {% for sev in severities %}
                        {% if severity == sev %}
                            <option selected>{{ sev }}</option>
                        {% else %}
                            <option>{{ sev }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                </li>
                <li>Description</li>
                <li><textarea class="form-control" name="package_description" rows="13">{{ incident.description }}</textarea></li>
                <li><button type="submit" class="btn btn-primary close-navsidebar">Submit</button></li>
            </ul>
            </form>
    </nav>
  </div>
</div>
<div id="commentsidebar" class="navsidebar navsidebar-right">
  <div id="commentsidebar-wrapper" class="commentsidebar-wrapper">
    <header class="navsidebar-header"><i class="fa fa-comment-o"></i>&nbsp;Kraut Commentor</header>
    <nav class="navsidebar-menu">
        <form action="{% url 'incidents:comment_incident' incident_id=incident_id %}" method="POST">
        {% csrf_token %}
            <ul>
                <li><div class="form-group"><label for="commentAuthor">Author:</label><div>{{ request.user  }}</div></div></li>
                <li><div class="form-group"><label for="incidentComment">Enter Comment:</label>{{ commentform.ctext }}</div></li>
                <li><button type="submit" class="btn btn-primary close-navsidebar">Comment</button></li>
            </ul>
        </form>
    </nav>
  </div>
</div>
{% endspaceless %}

<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">Incident Information
        </h3>
    </div>
    <div class="panel-body">
<div role="tabpanel">
  {% spaceless %}
  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    {% if num_incident_handlers > 0 %}
    <li role="presentation" {% if tab == 'incident_handler' %}class="active"{% endif %}>
        <a href="#incident_handler" aria-controls="incident_handler" role="tab" data-toggle="tab">
            <i class="fa fa-link"></i>&nbsp;&nbsp;Incident Handler
            <span class="badge">{{ num_incident_handlers }}</span>
        </a>
    </li>
    {% endif %}
    {% if num_incident_contacts > 0 %}
    <li role="presentation" {% if tab == 'incident_contacts' %}class="active"{% endif %}>
        <a href="#incident_contacts" aria-controls="incident_contacts" role="tab" data-toggle="tab">
            <i class="fa fa-link"></i>&nbsp;&nbsp;Incident Contacts
            <span class="badge">{{ num_incident_contacts }}</span>
        </a>
    </li>
    {% endif %}
    {% if num_incident_tasks > 0 %}
    <li role="presentation" {% if tab == 'incident_tasks' %}class="active"{% endif %}>
        <a href="#incident_tasks" aria-controls="incident_tasks" role="tab" data-toggle="tab">
            <i class="fa fa-link"></i>&nbsp;&nbsp;Incident Tasks
            <span class="badge">{{ num_incident_tasks }}</span>
        </a>
    </li>
    {% endif %}
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <!-- INCIDENT HANDLER -->
    <div role="tabpanel" class="tab-pane {% if tab == 'incident_handler' %}active{% endif %}" id="incident_handler">
        <br/>
        <table id="handler_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Short Description</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- INCIDENT CONTACT -->
    <div role="tabpanel" class="tab-pane {% if tab == 'incident_contacts' %}active{% endif %}" id="incident_contacts">
        <br/>
        <table id="contact_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Confidence</th><th>Status</th></tr>
            </thead>
            <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
            </tbody>
        </table>
    </div>
    <!-- INCIDENT TASK -->
    <div role="tabpanel" class="tab-pane {% if tab == 'incident_tasks' %}active{% endif %}" id="incident_tasks">
        <br/>
        <table id="task_table" class="table table-condensed" style="font-size: 0.9em;">
            <thead>
                <tr><th>Name</th><th>Short Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
  </div> <!-- END TAB CONTENT -->
</div>
</div>
</div>

{% if comments %}
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-comment-o"></i>&nbsp;Comments</h3>
    </div>
    <div class="panel-body">
       <table id="comment_table" class="table table-condensed" style="font-size: 0.9em;">
            <tbody>
                {% for comment in comments %}
                    <tr>
                        <td>Author:</td><td>{{ comment.author }}</td><td>Created:</td>
                        <td>
                            {{ comment.creation_time }}
                            {% if comment.author == request.user %}
                                <a href="{% url 'incidents:delete_comment_incident' incident_id=incident_id comment_id=comment.id %}"><i data-toggle="tooltip" data-placement="left" data-original-title="delete comment" class="fa fa-remove pull-right"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4"><pre class="pre-scrollable wrapdiv">{{ comment.ctext }}</pre></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Modal to add an existing threat actor to the package -->
<div class="modal bs-example-modal-lg" id="addTAModal" tabindex="-1" role="dialog" aria-labelledby="addTALabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addTALabel">Add Threat Actor</h4>
            </div>
                <div class="modal-body">
                    <table id="ta_table" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
        </div>
    </div>
</div>
<!-- Modal to add an existing campaign to the package -->
<div class="modal bs-example-modal-lg" id="addCAModal" tabindex="-1" role="dialog" aria-labelledby="addCALabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addCALabel">Add Campaign</h4>
            </div>
                <div class="modal-body">
                    <table id="ca_table" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
        </div>
    </div>
</div>
<!-- Modal to add an existing ttp to the package -->
<div class="modal bs-example-modal-lg" id="addTTPModal" tabindex="-1" role="dialog" aria-labelledby="addTTPLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addTTPLabel">Add Tools, Tactics, and Procedures</h4>
            </div>
                <div class="modal-body">
                    <table id="ttp_table" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
        </div>
    </div>
</div>
<!-- Modal to add an existing indicator to the package -->
<div class="modal bs-example-modal-lg" id="addINModal" tabindex="-1" role="dialog" aria-labelledby="addINLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addINLabel">Add Indicator</h4>
            </div>
                <div class="modal-body">
                    <table id="indicator_table" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
        </div>
    </div>
</div>
<!-- Modal to add an existing observable to the package -->
<div class="modal bs-example-modal-lg" id="addOBModal" tabindex="-1" role="dialog" aria-labelledby="addOBLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addOBLabel">Add Observable</h4>
            </div>
                <div class="modal-body">
                    <table id="observable_table" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
        </div>
    </div>
</div>

{% endspaceless %}
{% endif %}
{% endblock%}

{% block javascript%}
<script type="text/javascript" language="javascript" class="init">

$(function () {
    $('[data-toggle="popover"]').popover()
});

$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});

$(document).ready(function() {
  $('#navsidebar').simplerSidebar({
    opener: '#toggle-navsidebar',
    sidebar: {
      align: 'right',
      width: 560,
      closingLinks: '.close-navsidebar',
      top: 60,
      animation: {
        duration: 10,
      }
    }
  });
});

$(document).ready(function() {
  $('#commentsidebar').simplerSidebar({
    opener: '#toggle-commentsidebar',
    sidebar: {
      align: 'right',
      width: 560,
      closingLinks: '.close-commentsidebar',
      top: 60,
      animation: {
        duration: 10,
      }
    }
  });
});
</script>
{% endblock%}
